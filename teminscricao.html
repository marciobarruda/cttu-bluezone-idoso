<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Consulta de inscrição</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/automacao/catraca-conecta/catraca-logo.png"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
        --shadow-strong: 0 14px 30px rgba(0, 35, 79, 0.15);
      }
      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
        padding: 1.5rem;
      }
      .card-status {
        border: 1px solid rgba(0, 83, 164, 0.08);
        background: var(--surface-strong);
        box-shadow: var(--shadow-strong);
        border-radius: 1rem;
      }
      .status-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .status-icon.loading {
        background: rgba(0, 83, 164, 0.08);
        color: var(--brand-primary);
        border: 1px solid var(--border-color);
      }
      .status-icon.success {
        background: rgba(46, 125, 50, 0.1);
        color: #2e7d32;
      }
      .status-icon.error {
        background: rgba(193, 18, 31, 0.12);
        color: #c1121f;
      }
      .payload-box {
        border: 1px dashed rgba(0, 83, 164, 0.2);
        background: linear-gradient(
          135deg,
          rgba(0, 83, 164, 0.04),
          rgba(0, 163, 255, 0.06)
        );
        border-radius: 0.75rem;
        padding: 1rem;
        color: var(--text-strong);
        font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <main class="container" style="max-width: 720px">
      <header class="text-center mb-4">
        <p class="text-uppercase fw-bold text-muted mb-1" style="letter-spacing: 0.15em">
          Zona Azul do Idoso
        </p>
        <h1 class="h3 fw-bold mb-0">Consulta de inscrição</h1>
        <p class="text-muted mt-2 mb-0">
          Carregando informações da inscrição vinculada ao CPF informado.
        </p>
      </header>

      <section class="card card-status p-4">
        <div class="d-flex align-items-start gap-3 mb-3">
          <div id="statusIcon" class="status-icon loading">
            <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
          </div>
          <div>
            <p class="text-muted mb-1 small">CPF</p>
            <p id="cpfTexto" class="mb-2 fw-semibold"></p>
            <p id="mensagem" class="mb-0">
              Consultando inscrição...
            </p>
          </div>
        </div>

        <div class="payload-box d-none" id="payloadBox"></div>
      </section>
    </main>

    <script>
      const cpfNumeros = "{{ $json.cpfNumeros ?? '' }}";
      const webhookUrl =
        "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/consultar-inscricao-por-cpf";

      const statusIcon = document.getElementById("statusIcon");
      const mensagemEl = document.getElementById("mensagem");
      const cpfTexto = document.getElementById("cpfTexto");
      const payloadBox = document.getElementById("payloadBox");

      function formatCpf(value) {
        const digits = String(value || "").replace(/\D+/g, "").slice(0, 11);
        if (digits.length !== 11) return digits;
        return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }

      function setStatus(type, message) {
        statusIcon.className = `status-icon ${type}`;
        mensagemEl.textContent = message;
      }

      function showPayload(data) {
        const formatted =
          typeof data === "string" ? data : JSON.stringify(data, null, 2);
        payloadBox.textContent = formatted;
        payloadBox.classList.remove("d-none");
      }

      async function consultarInscricao() {
        cpfTexto.textContent = formatCpf(cpfNumeros) || "CPF não informado";
        if (!cpfNumeros) {
          setStatus("error", "Não foi possível identificar o CPF para consulta.");
          return;
        }

        try {
          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cpfNumeros }),
          });

          const contentType = response.headers.get("content-type") || "";
          const isJson = contentType.includes("application/json");
          const payload = isJson ? await response.json() : await response.text();

          showPayload(payload);

          if (!response.ok) {
            setStatus(
              "error",
              "Não foi possível recuperar a inscrição. Tente novamente mais tarde."
            );
            return;
          }

          const mensagem =
            (payload && (payload.mensagem || payload.message)) ||
            "Consulta realizada com sucesso.";
          const inscricao = payload && (payload.inscricao || payload.numero);
          const complemento = inscricao
            ? `Inscrição identificada: ${inscricao}.`
            : "";

          setStatus(
            "success",
            `${mensagem}${complemento ? " " + complemento : ""}`.trim()
          );
        } catch (error) {
          console.error(error);
          setStatus(
            "error",
            "Erro de rede ao consultar a inscrição. Verifique sua conexão."
          );
        }
      }

      document.addEventListener("DOMContentLoaded", consultarInscricao);
    </script>
  </body>
</html>
